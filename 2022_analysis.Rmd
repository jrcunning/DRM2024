---
title: "2022_analysis"
author: "R. Cunning"
date: "2024-05-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = T)
```

```{r}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(lme4)
library(emmeans)
library(ggridges)
library(gamm4)
library(MASS)
library(tidyverse)
```

# Import data

### DRM data
```{r import_drm}
# Import DRM data
df <- read_csv("data/drm/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y"))

# Get day of the year number, week, and month for some model fitting
df <- df %>%
  mutate(Day = yday(Date),
         Week = week(Date),
         Week2 = factor(cut(Week, breaks = seq(0,52,2))),
         Week = factor(Week),
         Month = factor(month(Date)))

# Subset just 2015 surveys
df22 <- filter(df, year(Date) == "2022")

# # Change Deerfield to either Broward or South Palm Beach based on Lat = 26.32825
# df22[df22$Subregion == "Deerfield" & df22$Latitude > 26.32825, "Subregion"] <- "South Palm Beach"
# df22[df22$Subregion == "Deerfield" & df22$Latitude < 26.32825, "Subregion"] <- "Broward-Miami"

# Order Subregions from south to north
df22 <- df22 %>%
  mutate(Subregion = fct_relevel(Subregion, c("Tortugas--Dry Tortugas NP", "Marquesas-Tortugas Trans", "Marquesas", 
                                              "Lower Keys", "Middle Keys", "Mid-Upper Keys Transition", "Upper Keys",
                                              "Biscayne", "Broward-Miami", "South Palm Beach", 
                                              "North Palm Beach", "Martin")))

# Order Species alphabetically
df22 <- df22 %>%
  mutate(Species = factor(Species, levels = sort(levels(df$Species))))

# Are there any dead corals?
dead <- df22 %>% filter(Old + Recent >= 100)
# Remove  dead corals (nonbleaching related death?)
df22 <- df22 %>%
  anti_join(dead)

# Create ordinal variables and factors for bleaching severity
df22 <- df22 %>%
  mutate(Bleaching2 = case_when((is.na(Bleaching) & !grepl("TRS", `Other Conditions`)) ~ 0,
                                Bleaching == "P" ~ 1,
                                Bleaching == "PB" ~ 2,
                                Bleaching == "BL" ~ 3,
                                ((Old + Recent) >= 100 & grepl("TRS", `Other Conditions`)) ~ 4),
         Bleaching3 = factor(case_match(Bleaching2, 
                                 0 ~ "Healthy",
                                 1 ~ "Pale",
                                 2 ~ "Partially Bleached",
                                 3 ~ "Bleached",
                                 4 ~ "Dead"),
                             levels = c("Healthy", "Pale", "Partially Bleached", "Bleached", "Dead")))
```



### DHW data

```{r import_dhw}
# Import 2022 DHW data
dhw <- read_csv("data/dhw/2022/dhw_processed.csv") %>%
  mutate(across(where(is.character), as_factor)) %>%
  rename(Date = date) %>%
  dplyr::select(Site, Date, dhw)

# Get max DHW experienced in 2022 for each site as of the date surveyed?
# or something like cumulative DHW? I think there are lots of corals that already bleached and died by September onward that are not getting captured in the surveys...
  

# Get DHW values for each DRM survey site on the date surveyed -- join with DRM data
df22 <- left_join(df22, dhw, by = c("Site", "Date"))

# Get peak DHW values for each site (weeks 36-38) regardless of when surveyed)
peakdhw <- dhw %>%
  mutate(Week2 = factor(cut(week(Date), breaks = seq(1,52,2)))) %>%
  filter(Week2 == "(33,35]") %>%
  group_by(Site) %>%
  summarize(peakdhw = max(dhw))
df22 <- left_join(df22, peakdhw)
ggplot(df22, aes(x = dhw, y = peakdhw, color = Subregion)) + geom_point()
```

```{r}
save(df22, file = "output/2022.RData")
```



```{r subset_drm}
# Create subsets of DRM data for downstream analyses
### Subset just abundant species
sppcounts <- df22 %>%
  count(Species) %>%
  arrange(-n)
abund.spp <- sppcounts %>% filter(n > 100) %>% pull(Species)

### Create subsets
df22.keys <- df22 %>% filter(
  Subregion %in% c("Upper Keys", "Mid-Upper Keys Transition", "Middle Keys", 
                   "Lower Keys", "Marquesas", "Tortugas--Dry Tortugas NP"))
df22.abund <- df22 %>% filter(Species %in% abund.spp)
df22.keys.abund <- df22.keys %>% filter(Species %in% abund.spp)
df22.abund.nopfursint <- df22.abund %>% filter(!Species %in% c("PFUR", "SINT"))
```



# DRM dataset summary

### Number of corals surveyed
```{r drm_summary_corals}
# Total number of colonies of each species surveyed
knitr::kable(tibble(`Total number of corals surveyed:` = sum(sppcounts$n)), align = 'l')

# Print table by species (split into multiple tables for display purposes)
knitr::kable(list(sppcounts[1:10, 1:2],
             sppcounts[11:20, 1:2],
             sppcounts[21:30, 1:2],
             sppcounts[31:40, 1:2], 
             sppcounts[41:50, 1:2]),
             label = "tables", booktabs = TRUE)
```

### Number of sites surveyed
```{r drm_summary_surveys}
# Total number of surveys conducted
surveys <- df22 %>%
  distinct(Subregion, Date, Site, dhw)

surveys %>%
  count(Subregion) %>%
  janitor::adorn_totals() %>%
  knitr::kable(align = 'l')
```

### How surveys were spread over subregions, over time, and over the heatwave
```{r survey_distribution}
# How were 2023 surveys distributed across time and space?
surveys_by_date <- ggplot(surveys, aes(x = Date, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  labs(x = "Date", y = "") +
  theme(legend.position = "none")

# How were surveys distributed across DHW accumulation?
surveys_by_dhw <- ggplot(surveys, aes(x = dhw, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  theme(legend.position = "none") +
  theme(axis.text.y = element_blank()) +
  labs(x = "Degree Heating Weeks", y = "")

cowplot::plot_grid(surveys_by_date, surveys_by_dhw, ncol = 2, rel_widths = c(0.62, 0.38))
```

Surveys took place mostly in August and September, coinciding with the peak of the marine heatwave. Surveys went into October, by which point DHWs had begun decreasing. There is potential for some confounding effects between space, time, and degree of heating, so care must be taken in downstream analyses to account for this.

# Bleaching event summary

### DHWs by subregion
```{r dhw_summary}
# Plot DHWs for each individual site, colored by Subregion
alldhwplot <- dhw %>%
  left_join(distinct(df22, Site, Subregion)) %>%
  ggplot(aes(x = Date, y = dhw, color = Subregion, group = Site)) +
  geom_line(alpha = 0.1) +
  scale_y_continuous(breaks = seq(0, 23, 1)) +
  scale_x_date(breaks = "months", date_labels = "%b")

# Calculate mean DHW for all survey sites in each Subregion
meanDHW <- dhw %>%
  left_join(distinct(df22, Site, Subregion)) %>%
  group_by(Subregion, Date) %>%
  summarize(meanDHW = mean(dhw))

# Add mean DHW for each Subregion's sites to plot
alldhwplot +
  geom_line(data = meanDHW, aes(y = meanDHW, group = Subregion), lwd = 1)

# # Get maximum mean DHW for each Subregion
# maxmeanDHW <- meanDHW %>%
#   group_by(Subregion) %>%
#   summarize(maxmeanDHW = max(meanDHW))
```

DHWs in DRTO reached ~15.
DHWs in the Lower, Middle, and Upper Keys reached ~20.
DHWs in Biscayne reach 14-15, similar to DRTO.
DHWs in Miami and Broward reached 10-11.
DHWs in South Palm Beach also reached 10-12, and North Palm Beach ~8.
DHWs in Martin County reached ~3.

### Bleaching prevalence by subregion over time, and overall
```{r bleaching_summary_subregion_time}
# Percent of surveyed colonies with at least partial bleaching by Subregion and 2-Week periods
df22 %>%
  group_by(Week2, Subregion) %>%
  summarize(pctbl = sum(Bleaching2 > 1) / n()) %>%
  ggplot(aes(x = Week2, y = pctbl, group = Subregion, color = Subregion)) +
  geom_point() + 
  geom_line() +
  labs(y = "Percent of surveyed colonies with at least partial bleaching")

# Percent bleaching at all sites as function of DHW
df22 %>%
  group_by(Site, Subregion) %>%
  summarize(meandhw = mean(dhw),
              pctbl = sum(Bleaching2 > 1) / n()) %>%
  ggplot(aes(x = meandhw, y = pctbl)) +
  geom_point(aes(color = Subregion)) +
  geom_smooth(method = "gam") +
  labs(x = "DHW at time of survey", y = "Percent of surveyed colonies with at least partial bleaching")
```

Bleaching prevalence peaked in late August to early September, with ~70-100% of colonies bleached (â‰¥PB) in the Keys and Tortugas. At the same time, bleaching prevalence in Miami and Broward was <25%. Bleaching prevalence decreases in late September and October surveys, which may be due to death of bleached corals leading to them not being recorded in surveys.

```{r bleaching_summary_overall_subregion}
# Count number of bleached and unbleached colonies of each species at each site
summ <- df22.abund %>%
  group_by(Site, Species, Subregion, Week, Week2) %>%
  summarize(bl = sum(Bleaching2 > 1, na.rm = T),
            nb = sum(Bleaching2 <= 1, na.rm = T),
            dhw = mean(dhw))

# Plot raw proportion of bleached colonies surveyed in each subregion
summ %>%
  group_by(Subregion) %>%
  summarize(pctbl = sum(bl) / (sum(bl) + sum(nb)),
            dhw = mean(dhw)) %>%
  mutate(group = "allcorals") %>%
  ggplot(aes(y = Subregion)) +
  geom_point(aes(x = pctbl)) +
  geom_path(aes(x = pctbl, group = group)) +
  geom_point(aes(x = dhw / 25), color = "red") +
  geom_path(aes(x = dhw / 25, group = group), color = "red") +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, 0.1),
                     name = "% of all corals PB or worse when surveyed",
                     sec.axis = sec_axis(~.*25, name = "Mean DHWs when surveyed")) +
  theme(axis.text.x.top = element_text(color = "red"),
        axis.title.x.top = element_text(color = "red")) +
  labs(y = "")


# Model proportion of bleached colonies in each subregion, controlling for species and week of survey
## Use 2-Week periods in model, and predict based on weeks 34-35 (Week2 = "(33,35]" => (August 20-September 2))) = peak of heat stress, before too much mortality
mod <- glm(cbind(bl, nb) ~ Subregion + Species + Week2, family = "binomial", data = summ)
res <- emmeans(mod, specs = c("Subregion"), at = list(Week2 = factor("(33,35]")), type = "response")
# Join predicted bleaching prevalence for Aug20-Sep2 with average DHWs during same dates
mymaxdhw <- dhw %>%
  left_join(distinct(df22, Site, Subregion)) %>%
  filter(Date >= "2023-08-20", Date <= "2023-09-02") %>%
  group_by(Subregion, Date) %>%
  summarize(meanDHW = mean(dhw)) %>%
  group_by(Subregion) %>%
  summarize(maxDHW = max(meanDHW)) %>%
  drop_na()

regional23 <- as.tibble(res) %>% full_join(mymaxdhw) %>%
  mutate(group = "allcorals")

ggplot(regional23, aes(y = Subregion)) +
  geom_point(aes(x = prob)) +
  geom_errorbar(aes(xmin = asymp.LCL, xmax = asymp.UCL), width = 0) +
  geom_path(aes(x = prob, group = group)) +
  geom_point(aes(x = maxDHW / 25), color = "red") +
  geom_path(aes(x = maxDHW / 25, group = group), color = "red") +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, 0.1),
                     name = "Predicted % of 'avg coral' PB or worse [Aug20-Sep2]",
                     sec.axis = sec_axis(~.*25, name = "Max DHW [Aug20-Sep2]")) +
  theme(axis.text.x.top = element_text(color = "red"),
        axis.title.x.top = element_text(color = "red")) +
  labs(y = "")

regional23 %>% left_join(mymaxdhw) %>%
  pivot_longer(cols = c(prob, maxDHW))
ggplot(regional23, aes(y = Subregion)) +
  

save(regional23, file = "output/regional23.RData")
```