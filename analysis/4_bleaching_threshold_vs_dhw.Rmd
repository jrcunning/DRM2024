---
title: "thresh_dhw"
author: "R. Cunning"
date: "2024-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(tidyverse)
```

# Find the relationship between bleaching threshold (°C) and DHW accumulation

```{r}
# Import Florida Keys daily temperature data for 1985-2023
## Downloaded from: https://coralreefwatch.noaa.gov/product/vs/data/florida_keys.txt
temp0 <- read_delim("data/temperature/florida_keys_temperature.txt", skip = 20, trim_ws = TRUE)
temp <- temp0 %>%
  mutate(temp = `SST@90th_HS`) %>%
  dplyr::select(YYYY, MM, DD, temp) %>%
  unite(YYYY, MM, DD, col = "date", sep = "-") %>%
  mutate(date = as_date(date),
         yday = yday(date),
         year = year(date))

# Define Maximum Monthly Mean temperature for Florida Keys
mmm <- 29.6264 # Actual MMM for FL Keys

# Plot temperature for each year, and MMM
mytemp <- temp %>% filter(year < 2025) %>%
  ggplot(aes(x = yday, y = temp, color = factor(year), group = year, alpha = 0.5)) +
  geom_line(alpha = 0.4) +
  geom_hline(aes(yintercept = 29.624), lty = 2) +
  #geom_hline(aes(yintercept = 30.624), lty = 2) +
  theme_classic() +
  labs(x = "Day of year", y = "Temperature (°C)") +
  theme(legend.position = "none")

# DHWs accumulate when temperatures exceed the bleaching threshold, defined as MMM temperature + 1°C
# Simulate increased bleaching thresholds (i.e., MMM + 1°C + x), with x ranging from 0 to 1.5°C of additional increase
# Calculate DHWs for all simulated increased thresholds for each year of real temperature data
dhwout <- temp %>%
  group_by(year) %>%
  nest() %>%
  crossing(add = seq(0, 2.5, 0.1)) %>%
  mutate(dhd = map2(data, add, ~if_else(.x$temp > mmm + 1 + .y, (.x$temp - mmm) / 7, 0)),
         dhw = map2(data, dhd, ~slider::slide_index_sum(.y, .x$yday, before = 84L)),
         maxdhw = map_dbl(dhw, max))

# Compute reduction in DHW in each year based on each increase in threshold
# Keep only years where at least 1 DHW was accumulated (based on actual MMM)
diffs <- dhwout %>%
  group_by(year) %>%
  mutate(diff = maxdhw[add==0] - maxdhw) %>%
  filter(maxdhw > 0, max(maxdhw) > 2)

# Plot reduction in DHW for each year afforded by X°C increase in bleaching threshold
diffs_vs_add <- ggplot(diffs, aes(x = add, y = diff, group = year, color = factor(year))) + 
  #geom_point() +
  geom_path() +
  theme_classic() +
  labs(x = "Simulated increase in bleaching threshold (°C)",
       y = "Decrease in accumulated DHW")

# Model reduction in DHW as a function of simulated increase
## Constrain intercept to zero, and have random slopes for years
mod <- lmer(diff ~ 0 + add + (0 + add|year), data = diffs)
## Get slope and standard error
coefs <- tibble(
  dhw.per.degC = summary(mod)$coefficients[1],
  dhw.per.degC.se = summary(mod)$coefficients[2]
)

# Plot fitted model over simulated data
anno <- paste0("y = ", round(coefs[1], 2), " x")
(figs3 <- diffs_vs_add + 
    geom_abline(aes(slope = coefs$dhw.per.degC, intercept = 0),
                           alpha = 0.5, linewidth = 1.5) +
    scale_color_discrete(name = "") +
    annotate("text", label = anno, x = 1.5, y = 1, hjust = 1) +
    theme(legend.text = element_text(size = 8),
          legend.key.size = unit(5, "mm")) +
    coord_cartesian(xlim = c(0, 1.5), ylim = c(0, 11), expand = FALSE))

ggsave(filename = "figures/FigS3.png", plot = figs3, width = 140, height = 90, units = "mm")
coefs

## Save slope and standard error for analysis in analysis_main
write_csv(coefs, "data/processed/dhw.per.degC.csv")
```

