---
title: "2023 DHW analysis for DRM survey locations"
output: html_document
date: "2024-05-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ncdf4) # package for netcdf manipulation
library(raster) # package for raster manipulation
library(tidyverse)
```

DHW data downloaded 5/1/24 using:
wget -r -l1 -A "ct*" https://www.star.nesdis.noaa.gov/pub/sod/mecb/crw/data/5km/v3.1_op/nc/v1.0/daily/dhw/2023/

netcdf tutorial here: https://rpubs.com/boyerag/297592

# 2023

```{r}
# Import all NetCDF files for each date from June 1 through December 31, 2023
nc.files <- list.files("data/dhw/2023", pattern = "*.nc$", full.names = TRUE)

# Get coordinate box for Florida Reef Tract
#nc <- nc_open("data/dhw/ct5km_dhw_v3.1_20230901.nc")
#nct <- ncvar_get(nc, "degree_heating_week", start = c(2000, 1240,1), count = c(21, 81,1))
# Longitude -83.525 --> index 1930
#nc$dim$lon$vals[2021]
# Longitude -78.975 --> index 2021
# Latitude 24 --> index 1321
#nc$dim$lat$vals[1240]
# Latitude 28 --> index 1240

# Get DRM survey site coordinates
# Import data
drmsites <- read_csv("data/drm/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y")) %>%
  filter(year(Date) == "2023") %>%
  distinct(Site, Subregion, Longitude, Latitude)

# Open all DHW NCDF4 files
nc.data <- tibble(file = nc.files) %>%
  mutate(date = map_chr(file, ~str_extract(., "2023\\d+"), format = "%Y%m%d"),
         data = map(file, nc_open),
      dhw.all = map(data, ~ncvar_get(., "degree_heating_week", start = c(1930, 1240, 1), count = c(91, 81, 1))),
            r = map(dhw.all, ~raster(t(.), xmn = -83.525, xmx = -78.975, ymn = 23.975, ymx = 28.025,
                                     crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))),
       coords = list(drmsites),
          dhw = map2(r, coords, ~raster::extract(.x, SpatialPoints(.y[,3:4]), method = "simple")))


###### GET NEAREST PIXEL INSTEAD OF NEAREST SITE
buf_m <- 6000  # 

extract_dhw <- function(r, df_xy, buf = buf_m) {
  sp <- SpatialPoints(df_xy[, c("Longitude","Latitude")], proj4string = crs(r))

  v_simple <- raster::extract(r, sp, method = "simple")

  # buffered mean ignoring NA; will still be NA if *all* nearby cells are NA
  v_buf <- raster::extract(r, sp, buffer = buf, fun = mean, na.rm = TRUE)

  # use simple unless it's NA, then buffered
  ifelse(is.na(v_simple), v_buf, v_simple)
}

nc.data <- nc.data %>%
  mutate(
    dhw = map(r, ~extract_dhw(.x, drmsites, buf = buf_m))
  )

out2 <- nc.data %>%
  mutate(
    date = as.Date(date, "%Y%m%d"),
    site = list(drmsites %>% dplyr::select(Site, Subregion, Longitude, Latitude)),
    # sanity check: dhw vector length should equal nrow(drmsites)
    n_dhw = map_int(dhw, length),
    n_site = map_int(site, nrow)
  ) %>%
  # optional: stop early if something doesn't match
  filter(n_dhw == n_site) %>%
  dplyr::select(date, site, dhw) %>%
  unnest(cols = c(site, dhw))
```

```{r}
# Plot DHWs for all sites
ggplot(out2, aes(x = date, y = dhw, color = Subregion, group = Site)) +
  geom_line() +
  scale_x_date(date_breaks = "month", date_labels = "%b")
```

```{r}
# Write DHW data to file
write_csv(out2, file = "data/processed/2023_dhw_processed.csv")
```

# 2015

```{r}
# Import all NetCDF files for each date from June 1 through December 31, 2015
nc.files <- list.files("data/dhw/2015", pattern = "*.nc$", full.names = TRUE)

# Get coordinate box for Florida Reef Tract
#nc <- nc_open("data/dhw/ct5km_dhw_v3.1_20230901.nc")
#nct <- ncvar_get(nc, "degree_heating_week", start = c(2000, 1240,1), count = c(21, 81,1))
# Longitude -83.525 --> index 1930
#nc$dim$lon$vals[2021]
# Longitude -78.975 --> index 2021
# Latitude 24 --> index 1321
#nc$dim$lat$vals[1240]
# Latitude 28 --> index 1240

# Get DRM survey site coordinates
# Import data
drmsites <- read_csv("data/drm/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y")) %>%
  filter(year(Date) == "2015") %>%
  distinct(Site, Subregion, Longitude, Latitude)

# Open all DHW NCDF4 files
nc.data <- tibble(file = nc.files) %>%
  mutate(date = map_chr(file, ~str_extract(., "2015\\d+"), format = "%Y%m%d"),
         data = map(file, nc_open),
      dhw.all = map(data, ~ncvar_get(., "degree_heating_week", start = c(1930, 1240, 1), count = c(91, 81, 1))),
            r = map(dhw.all, ~raster(t(.), xmn = -83.525, xmx = -78.975, ymn = 23.975, ymx = 28.025,
                                     crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))),
       coords = list(drmsites),
          dhw = map2(r, coords, ~raster::extract(.x, SpatialPoints(.y[,3:4]), method = "simple")))

###### GET NEAREST PIXEL INSTEAD OF NEAREST SITE
buf_m <- 6000  # 

extract_dhw <- function(r, df_xy, buf = buf_m) {
  sp <- SpatialPoints(df_xy[, c("Longitude","Latitude")], proj4string = crs(r))

  v_simple <- raster::extract(r, sp, method = "simple")

  # buffered mean ignoring NA; will still be NA if *all* nearby cells are NA
  v_buf <- raster::extract(r, sp, buffer = buf, fun = mean, na.rm = TRUE)

  # use simple unless it's NA, then buffered
  ifelse(is.na(v_simple), v_buf, v_simple)
}

nc.data <- nc.data %>%
  mutate(
    dhw = map(r, ~extract_dhw(.x, drmsites, buf = buf_m))
  )

out2 <- nc.data %>%
  mutate(
    date = as.Date(date, "%Y%m%d"),
    site = list(drmsites %>% dplyr::select(Site, Subregion, Longitude, Latitude)),
    # sanity check: dhw vector length should equal nrow(drmsites)
    n_dhw = map_int(dhw, length),
    n_site = map_int(site, nrow)
  ) %>%
  # optional: stop early if something doesn't match
  filter(n_dhw == n_site) %>%
  dplyr::select(date, site, dhw) %>%
  unnest(cols = c(site, dhw))
```

```{r}
# Plot DHWs for all sites
ggplot(out2, aes(x = date, y = dhw, color = Subregion, group = Site)) +
  geom_line() +
  scale_x_date(date_breaks = "month", date_labels = "%b")
```

```{r}
# Write DHW data to file
write_csv(out2, file = "data/processed/2015_dhw_processed.csv")
```


# 2014
```{r}
# Import all NetCDF files for each date from June 1 through December 31, 2015
nc.files <- list.files("data/dhw/2014", pattern = "*.nc$", full.names = TRUE)

# Get coordinate box for Florida Reef Tract
#nc <- nc_open("data/dhw/ct5km_dhw_v3.1_20230901.nc")
#nct <- ncvar_get(nc, "degree_heating_week", start = c(2000, 1240,1), count = c(21, 81,1))
# Longitude -83.525 --> index 1930
#nc$dim$lon$vals[2021]
# Longitude -78.975 --> index 2021
# Latitude 24 --> index 1321
#nc$dim$lat$vals[1240]
# Latitude 28 --> index 1240

# Get DRM survey site coordinates
# Import data
drmsites <- read_csv("data/drm/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y")) %>%
  filter(year(Date) == "2014") %>%
  distinct(Site, Subregion, Longitude, Latitude)

# Open all DHW NCDF4 files
nc.data <- tibble(file = nc.files) %>%
  mutate(date = map_chr(file, ~str_extract(., "2014\\d+"), format = "%Y%m%d"),
         data = map(file, nc_open),
      dhw.all = map(data, ~ncvar_get(., "degree_heating_week", start = c(1930, 1240, 1), count = c(91, 81, 1))),
            r = map(dhw.all, ~raster(t(.), xmn = -83.525, xmx = -78.975, ymn = 23.975, ymx = 28.025,
                                     crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))),
       coords = list(drmsites),
          dhw = map2(r, coords, ~raster::extract(.x, SpatialPoints(.y[,3:4]), method = "simple")))


###### GET NEAREST PIXEL INSTEAD OF NEAREST SITE
buf_m <- 6000  # 

extract_dhw <- function(r, df_xy, buf = buf_m) {
  sp <- SpatialPoints(df_xy[, c("Longitude","Latitude")], proj4string = crs(r))

  v_simple <- raster::extract(r, sp, method = "simple")

  # buffered mean ignoring NA; will still be NA if *all* nearby cells are NA
  v_buf <- raster::extract(r, sp, buffer = buf, fun = mean, na.rm = TRUE)

  # use simple unless it's NA, then buffered
  ifelse(is.na(v_simple), v_buf, v_simple)
}

nc.data <- nc.data %>%
  mutate(
    dhw = map(r, ~extract_dhw(.x, drmsites, buf = buf_m))
  )

out2 <- nc.data %>%
  mutate(
    date = as.Date(date, "%Y%m%d"),
    site = list(drmsites %>% dplyr::select(Site, Subregion, Longitude, Latitude)),
    # sanity check: dhw vector length should equal nrow(drmsites)
    n_dhw = map_int(dhw, length),
    n_site = map_int(site, nrow)
  ) %>%
  # optional: stop early if something doesn't match
  filter(n_dhw == n_site) %>%
  dplyr::select(date, site, dhw) %>%
  unnest(cols = c(site, dhw))
```

```{r}
# Plot DHWs for all sites
ggplot(out2, aes(x = date, y = dhw, color = Subregion, group = Site)) +
  geom_line() +
  scale_x_date(date_breaks = "month", date_labels = "%b")
```

```{r}
# Write DHW data to file
write_csv(out2, file = "data/processed/2014_dhw_processed.csv")
```

# 2024

```{r}
# Import all NetCDF files for each date from June 1 through December 31, 2024
nc.files <- list.files("data/dhw/2024", pattern = "*.nc$", full.names = TRUE)

# Get DRM survey site coordinates
# Import data
drmsites <- read_csv("data/drm/FRRP_EXPORT.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y %H:%M:%S")) %>%
  filter(year(Date) == "2024") %>%
  distinct(Site, Subregion, Longitude, Latitude)

# Open all DHW NCDF4 files
nc.data <- tibble(file = nc.files) %>%
  mutate(date = map_chr(file, ~str_extract(., "2024\\d+"), format = "%Y%m%d"),
         data = map(file, nc_open),
      dhw.all = map(data, ~ncvar_get(., "degree_heating_week", start = c(1930, 1240, 1), count = c(91, 81, 1))),
            r = map(dhw.all, ~raster(t(.), xmn = -83.525, xmx = -78.975, ymn = 23.975, ymx = 28.025,
                                     crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))),
       coords = list(drmsites),
          dhw = map2(r, coords, ~raster::extract(.x, SpatialPoints(.y[,3:4]), method = "simple")))

# Get dhw data for all site coords
# use a buffer of 5km to get nearest data for sites that are outside data pixels
buf_m <- 5000  # 

extract_dhw <- function(r, df_xy, buf = buf_m) {
  sp <- SpatialPoints(df_xy[, c("Longitude","Latitude")], proj4string = crs(r))

  v_simple <- raster::extract(r, sp, method = "simple")

  # buffered mean ignoring NA; will still be NA if *all* nearby cells are NA
  v_buf <- raster::extract(r, sp, buffer = buf, fun = mean, na.rm = TRUE)

  # use simple unless it's NA, then buffered
  ifelse(is.na(v_simple), v_buf, v_simple)
}

nc.data <- nc.data %>%
  mutate(
    dhw = map(r, ~extract_dhw(.x, drmsites, buf = buf_m))
  )

out2 <- nc.data %>%
  mutate(
    date = as.Date(date, "%Y%m%d"),
    site = list(drmsites %>% dplyr::select(Site, Subregion, Longitude, Latitude)),
    # sanity check: dhw vector length should equal nrow(drmsites)
    n_dhw = map_int(dhw, length),
    n_site = map_int(site, nrow)
  ) %>%
  # optional: stop early if something doesn't match
  filter(n_dhw == n_site) %>%
  dplyr::select(date, site, dhw) %>%
  unnest(cols = c(site, dhw))

# re-check missing sites
dhws <- out2 %>% group_by(Site, Latitude, Longitude) %>% summarize(maxdhw = max(dhw, na.rm = TRUE), .groups="drop")
nodhw <- dhws %>% filter(is.na(maxdhw))
nodhw


```

```{r}
# Plot DHWs for all sites
ggplot(out2, aes(x = date, y = dhw, color = Subregion, group = Site)) +
  geom_line() +
  scale_x_date(date_breaks = "month", date_labels = "%b")
```

```{r}
# Write DHW data to file
write_csv(out2, file = "data/processed/2024_dhw_processed.csv")
```


