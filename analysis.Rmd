---
title: "Untitled"
output: html_document
date: "2024-04-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lme4)
library(emmeans)
library(ggridges)
library(gamm4)
```


```{r}
# Import data
df <- read_csv("data/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y"))

# Get day of the year number, week, and month for some model fitting
df <- df %>%
  mutate(Day = yday(Date),
         Week = factor(week(Date)),
         Month = factor(month(Date)))

# Order Subregions from south to north
df <- df %>%
  mutate(Subregion = fct_relevel(Subregion, c("Tortugas--Dry Tortugas NP", "Marquesas", "Lower Keys", 
                                              "Middle Keys", "Mid-Upper Keys Transition", "Upper Keys",
                                              "Biscayne", "Broward-Miami", "South Palm Beach", 
                                              "North Palm Beach", "Martin")))

# Create ordinal variable for bleaching severity
df <- df %>%
  mutate(Bleaching2 = case_when((is.na(Bleaching) & !grepl("TRS", `Other Conditions`)) ~ 0,
                                Bleaching == "P" ~ 1,
                                Bleaching == "PB" ~ 2,
                                Bleaching == "BL" ~ 3,
                                ((Old + Recent) >= 100 & grepl("TRS", `Other Conditions`)) ~ 4))

#### There are 45 corals listed with "TRS" but are blank for "Bleaching"... talk to Jennifer about these?
#### For now, remove these from analysis
df <- df %>%
  filter(!is.na(Bleaching2))

# Subset just 2023 surveys
df23 <- filter(df, year(Date) == "2023")

# Import 2023 DHW data
dhw <- read_csv("data/dhw/dhw_processed.csv") %>%
  mutate(across(where(is.character), as_factor)) %>%
  rename(Date = date) %>%
  dplyr::select(Site, Date, dhw)

# Get DHW values for each DRM survey site on date surveyed
df23 <- left_join(df23, dhw, by = c("Site", "Date"))
```


```{r}
# How were 2023 surveys distributed across time and space?
surveys <- df23 %>%
  distinct(Subregion, Date, Site)

ggplot(surveys, aes(x = Date, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  theme(legend.position = "none")

# Did overall bleaching severity change over time?

## Fit GAMM for overall bleaching level over time within each Subregion
mod <- gam(Bleaching2 ~ s(Day, by = Subregion), data = df23)
res <- emmeans(mod, specs = "Day", by = "Subregion", at = list(Day = seq(167, 318, 1)))
# Plot 
df23 %>%
  distinct(Subregion, Day, Date) %>%
  arrange(Subregion, Date) %>%
  left_join(as.tibble(res)) %>%
  mutate(Date = as.Date(Day, origin = as.Date("2024-01-01"))) %>%
  ggplot(aes(x = Date, y = emmean, color = Subregion, group = Subregion)) +
  geom_line() +
  ylim(0, 3)

## Fit by factor Week
mod <- lmer(Bleaching2 ~ factor(Week) * Subregion + (1|Species) + (1|Site), data = df23)
res <- emmeans(mod, specs = "Week", by = "Subregion")
# Plot
as.tibble(res) %>%
  drop_na(emmean) %>%
  ggplot(aes(x = Week, y = emmean, color = Subregion, group = Subregion)) +
  geom_line() +
  ylim(0, 3)


# How many sites per Subregion?
# How are reef Zones diff across Subregions?
df23ss %>%
  distinct(Subregion, Site, Zone) %>%
  group_by(Subregion) %>%
  ggplot(aes(x = Subregion, fill = Zone)) +
  geom_bar(position = "stack") +
  scale_y_continuous(breaks = seq(0, 100, 10))
```

    
```{r}
# - [ ] Bleaching severity by species (in relation to location and DHW). which species more/less bleached

df23ss <- df23 #%>%
  # Subset mid-August to end of September? (stable peak of bleaching to allow comparing across Subregions, e.g. Marquesas was in Oct. only)
  #filter(Date >= "2023-08-15" & Date <= "2023-09-30")

# Filter out dead corals from causes OTHER than bleaching ("TRS")
df23ss <- df23ss %>%
  filter(((Old + Recent) < 100 | grepl("TRS", `Other Conditions`)))

# Filter 1: Subset just species with over 100 observations in 2023?
abund_spp <- df23ss %>%
  count(Species) %>%
  filter(n >= 100) %>%
  pull(Species)

# Filter 2: Subset just species with >=5 observations per Subregion?
abund_spp2 <- df23ss %>%
  group_by(Subregion) %>%
  count(Species) %>%
  filter(n >= 5)

df23ss <- df23ss %>% 
  #filter(Species %in% abund_spp) %>%.     # Apply filter 1
  right_join(abund_spp2) %>%               # Apply filter 2
  mutate(Species = droplevels(Species))

# Model bleaching severity by species
mod <- lmerTest::lmer(Bleaching2 ~ Species * Subregion + (1|Site) + (1|Month), data = df23ss)
anova(mod)

emm <- emmeans(mod, specs = "Species", by = "Subregion")

as.tibble(emm) %>%
  ggplot(aes(x = Subregion, y = emmean, color = Species, group = Species)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Species)


# Ordinal regression? taking forever, does not finish
library(ordinal)
mod <- clmm(as.factor(Bleaching2) ~ Species * Subregion + (1|Site) + (1|Month), data = df23ss)
emm <- emmeans(mod, specs = "Species", by = "Subregion")
```

```{r}
# bleaching analysis with DHW as covariate?
# Model bleaching severity by species
mod <- lmerTest::lmer(Bleaching2 ~ Species * dhw + (1|Site), data = df23ss)
anova(mod)

emm <- emmeans(mod, specs = c("Species", "dhw"), at = list(dhw = seq(0,25,1)))

as.tibble(emm) %>%
  ggplot(aes(x = dhw, y = emmean, color = Species, group = Species)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Species) +
  ylim(0, 4)

# Try binning DHW
df23ss <- df23ss %>%
  mutate(dhw.bin = cut(dhw, breaks = c(0,4,8,12,16,20,24)))
mod <- lmerTest::lmer(Bleaching2 ~ Species * dhw.bin + (1|Site), data = df23ss)
anova(mod)

emm <- emmeans(mod, specs = c("Species", "dhw.bin"), at = list(dhw.bin = levels(df23ss$dhw.bin)))

as.tibble(emm) %>%
  ggplot(aes(x = dhw.bin, y = emmean, color = Species, group = Species)) +
  geom_point() +
  geom_line() +
  #facet_wrap(~Species) +
  ylim(0, 4)



# Need to try some binomial modeling with BL as response (1=BL, 0=notBL) to model proportion of colonies bleached at various locations and dhw levels....
```




```{r}
# - [ ] Variability in bleaching among individuals within a species 
### which spp have the most variability among individuals?

var <- df23ss %>%
  group_by(Site, Latitude, Longitude, Species, Subregion, Zone) %>%
  summarize(n = n(),
            bleachvar = var(Bleaching2),
            max = max(Bleaching2)) %>%
  filter(n >= 10, max == 3, bleachvar > 0)

ggplot(var, aes(x = Species, y = bleachvar)) +
  geom_violin(scale = "width", draw_quantiles = 0.5) +
  geom_jitter(aes(color = Subregion), width = 0.2)

## where do tol. and sens. individuals co-occur?

var %>% filter(Species == "MCAV") %>%
  ggplot(aes(x = Longitude, y = Latitude)) +
  geom_point(aes(color = bleachvar))


#### Barplots of bleaching categories for each species
filter(df23ss, Species == "SSID") %>%
  ggplot(aes(x = Week, fill = factor(Bleaching2))) +
  geom_bar(position = "fill") +
  facet_grid(Subregion~"")
```

```{r}
#  - [ ] Where are heat-tolerant individuals? i.e., most non-bleached individuals rel. to DHW
```


```{r}
# - [ ] Are juveniles doing better (less bleaching) than larger adult colonies for any species?

# Model bleaching severity by species and size class
df23ss <- df23ss %>%
  mutate(sizeclass = case_when(Width <= 8 & (Old + Recent) <= 10 ~ "juv",
                               TRUE ~ "adult"))
mod <- lmerTest::lmer(Bleaching2 ~ sizeclass * Species + Subregion + (1|Site) + (1|Month), 
                      data = filter(df23ss, !Subregion %in% c("Broward-Miami", "South Palm Beach",
                                                              "North Palm Beach", "Martin")))
anova(mod)

emm <- emmeans(mod, specs = c("Species", "sizeclass"))
as.tibble(emm) %>%
  ggplot(aes(x = sizeclass, y = emmean)) +
  facet_wrap(~Species, scales = "free") +
  geom_point() +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL))

stats <- rbind(contrast(emm, "pairwise", by = "Species")) %>%
  as.tibble() %>%
  arrange(p.value) %>%
  print(n = nrow(.))

sigspp <- stats %>%
  filter(p.value < 0.05)

as.tibble(emm) %>%
  filter(Species %in% sigspp$Species) %>%
  ggplot(aes(x = sizeclass, y = emmean)) +
  facet_wrap(~Species) +
  geom_point() +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL))
```
    

    
