---
title: "Untitled"
output: html_document
date: "2024-04-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(lme4)
library(emmeans)
library(ggridges)
library(gamm4)
library(MASS)
library(tidyverse)
```

# Import data

### DRM data
```{r import_drm}
# Import DRM data
df <- read_csv("data/drm/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y"))

# Get day of the year number, week, and month for some model fitting
df <- df %>%
  mutate(Day = yday(Date),
         Week = factor(week(Date)),
         Month = factor(month(Date)))

# Subset just 2023 surveys
df23 <- filter(df, year(Date) == "2023")

# Order Subregions from south to north
df23 <- df23 %>%
  mutate(Subregion = fct_relevel(Subregion, c("Tortugas--Dry Tortugas NP", "Marquesas", "Lower Keys", 
                                              "Middle Keys", "Mid-Upper Keys Transition", "Upper Keys",
                                              "Biscayne", "Broward-Miami", "South Palm Beach", 
                                              "North Palm Beach", "Martin")))

# Order Species alphabetically
df23 <- df23 %>%
  mutate(Species = factor(Species, levels = sort(levels(df$Species))))

# Create ordinal variables and factors for bleaching severity
df23 <- df23 %>%
  mutate(Bleaching2 = case_when((is.na(Bleaching) & !grepl("TRS", `Other Conditions`)) ~ 0,
                                Bleaching == "P" ~ 1,
                                Bleaching == "PB" ~ 2,
                                Bleaching == "BL" ~ 3,
                                ((Old + Recent) >= 100 & grepl("TRS", `Other Conditions`)) ~ 4),
         Bleaching3 = factor(case_match(Bleaching2, 
                                 0 ~ "Healthy",
                                 1 ~ "Pale",
                                 2 ~ "Partially Bleached",
                                 3 ~ "Bleached",
                                 4 ~ "Dead"),
                             levels = c("Healthy", "Pale", "Partially Bleached", "Bleached", "Dead")))
```

```{r qc_drm, include = FALSE}
#### There are 45 corals listed with "TRS" but are blank for "Bleaching"... talk to Jennifer about these?
#### For now, remove these from analysis
df23 <- df23 %>%
  filter(!is.na(Bleaching2))

### There are 34 corals with Width < 4 ... keep? or errors?
df23 %>% filter(Width < 4)

# Filter out dead corals from causes OTHER than bleaching ("TRS") -- why are these in data?
df23 <- df23 %>%
  filter(((Old + Recent) < 100 | grepl("TRS", `Other Conditions`)))
```

```{r subset_drm}
# Create subsets of DRM data for downstream analyses
### Subset just Subregions in the keys down
keys <- c("Upper Keys", "Mid-Upper Keys Transition", "Middle Keys", 
          "Lower Keys", "Marquesas", "Tortugas--Dry Tortugas NP")
### Subset just abundant species
sppcounts <- df23 %>%
  count(Species) %>%
  arrange(-n)
abund.spp <- sppcounts %>% filter(n > 100) %>% pull(Species)
### Create subsets
df23.keys <- df23 %>% filter(Subregion %in% keys)
df23.abund <- df23 %>% filter(Species %in% abund.spp)
df23.keys.abund <- df23 %>% filter(Subregion %in% keys, Species %in% abund.spp)
```

### DHW data

```{r import_dhw}
# Import 2023 DHW data
dhw <- read_csv("data/dhw/dhw_processed.csv") %>%
  mutate(across(where(is.character), as_factor)) %>%
  rename(Date = date) %>%
  dplyr::select(Site, Date, dhw)

# Get DHW values for each DRM survey site on the date surveyed -- join with DRM data
df23 <- left_join(df23, dhw, by = c("Site", "Date"))

# Create binned DHW variable
df23 <- df23 %>%
  mutate(dhw.bin = cut(dhw, breaks = c(0,4,8,12,16,20,24)))
```

# DRM dataset summary

### Number of corals surveyed
```{r drm_summary_corals}
# Total number of colonies of each species surveyed
sppcounts <- df23 %>%
  count(Species) %>%
  arrange(-n) 

knitr::kable(tibble(`Total number of corals surveyed:` = sum(sppcounts$n)), align = 'l')

# Print table by species (split into multiple tables for display purposes)
knitr::kable(list(sppcounts[1:10, 1:2],
             sppcounts[11:20, 1:2],
             sppcounts[21:30, 1:2],
             sppcounts[31:40, 1:2], 
             sppcounts[41:50, 1:2]),
             label = "tables", booktabs = TRUE)
```

### Number of sites surveyed
```{r drm_summary_surveys}
# Total number of surveys conducted
surveys <- df23 %>%
  distinct(Subregion, Date, Site, dhw)

knitr::kable(tibble(`Total number of sites surveyed:` = n_distinct(surveys$Site)), align = 'l')


# Number of sites and reef zones surveyed per Subregion
df23 %>%
  distinct(Subregion, Site, Zone) %>%
  group_by(Subregion) %>%
  ggplot(aes(x = Subregion, fill = Zone)) +
  geom_bar(position = "stack") +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  labs(x = "", y = "Number of sites surveyed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# How were 2023 surveys distributed across time and space?
surveys_by_date <- ggplot(surveys, aes(x = Date, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  labs(x = "Date", y = "") +
  theme(legend.position = "none")

# How were surveys distributed across DHW accumulation?
surveys_by_dhw <- ggplot(surveys, aes(x = dhw, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  theme(legend.position = "none") +
  theme(axis.text.y = element_blank()) +
  labs(x = "Degree Heating Weeks", y = "")

cowplot::plot_grid(surveys_by_date, surveys_by_dhw, ncol = 2, rel_widths = c(0.62, 0.38))
```

# Bleaching event summary

### DHWs by subregion
```{r dhw_summary}
# Calculate mean DHW for all survey sites in each Subregion, by date
meanDHW <- dhw %>%
  left_join(distinct(df23, Site, Subregion)) %>%
  group_by(Subregion, Date) %>%
  summarize(meanDHW = mean(dhw))
# Plot mean DHW over time for each Subregion
ggplot(meanDHW, aes(x = Date, y = meanDHW, color = Subregion, group = Subregion)) +
  geom_line() +
  labs(y = "Mean DHW of all sites surveyed in Subregion")
```

### Bleaching prevalence by subregion
```{r bleaching_summary}
# Model probability of all corals being at least Partially bleached by Week and Subregion
mod <- glm((Bleaching2 > 1) ~ Week:Subregion, family = "binomial", data = df23)
res <- as.tibble(emmeans(mod, specs = c("Week", "Subregion"), type = "response")) %>% 
  drop_na() %>%
  mutate(Date = as.Date("2023-01-01") + ((as.numeric(as.character(Week)) - 1) * 7))
ggplot(res, aes(x = Date, y = response, color = Subregion, group = Subregion)) +
  geom_point() + 
  geom_line() +
  labs(y = "Percent of surveyed colonies with at least partial bleaching")

# Percent of all corals observed that were partially bleached or worse
pct_pb <- df23 %>% group_by(Subregion) %>%
  count(Bleaching2 > 1) %>%
  summarize(`% of all surveyed colonies with at least partial bleaching` = n[`Bleaching2 > 1`] / sum(n))
knitr::kable(pct_pb)
```

### Bleaching prevalence for all corals with increasing DHWs
```{r bleaching_vs_dhw}
# Ordinal regression: Probability of each bleaching level with increasing DHW
m <- polr(Bleaching3 ~ dhw, data = df23, Hess = TRUE, model = TRUE)

res <- emmeans(m, specs = c("dhw", "Bleaching3"), 
               at = list(dhw = seq(0, 22, 1)), 
               mode = "prob")
as.tibble(res) %>%
  ggplot(aes(x = dhw, y = prob, color = Bleaching3)) +
  geom_line() +
  labs(x = "Degree Heating Weeks", y = "Predicted probability - all corals")
```

# Species differences in bleaching

### Bleaching prevalence by species in each subregion
```{r bleaching_by_species_and_region}
# Model probability of being at least Partially bleached by Species and Subregion (controlling for Week)
### Subset: only include species observed at least 3 times in a Subregion...
df23.abund.ss <- df23.abund %>%
  count(Species, Subregion) %>%
  filter(n >=3) %>%
  left_join(df23.abund)
# Fit model
mod <- glmer((Bleaching2 > 1) ~ Subregion * Species + (1|Week), 
             family = "binomial", data = df23.abund.ss,
             nAGQ = 0, control = glmerControl(optimizer = "nloptwrap"))
res <- as.tibble(emmeans(mod, specs = c("Species", "Subregion"), type = "response")) %>% drop_na()
# Plot
ggplot(res, aes(x = Subregion, y = response, color = Species, group = Species)) +
  geom_point() + 
  geom_line() +
  facet_wrap(~Species) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(x = "", y = "Prevalence of bleaching (PB or worse)")
```

### Species differences in bleaching with increasing DHWs
```{r, eval = F}
# Probability of each bleaching level by species as a function of DHW (ordinal regression)
#https://tdunn.ca/posts/2020-03-15-ordinal-regression-in-r-part-1/

# Fit ordinal regression model for each species as a function of DHW
m <- polr(Bleaching3 ~ Species * dhw, data = df23.abund, Hess = TRUE, model = TRUE)
## Does this need random factors? Cannot get clmm to work...

# Get fitted values
res <- emmeans(m, specs = c("dhw", "Bleaching3"), by = "Species", mode = "prob", at = list(dhw = seq(0, 23, 1)))

# Get threshold where >50% of colonies are bleached, for each species
thresh <- as.tibble(res) %>%
  filter(Bleaching3 == "Bleached") %>%
  group_by(Species) %>%
  summarize(thresh = min(dhw[prob > 0.5])) %>%
  mutate(Species = fct_reorder(Species, thresh))

# Get threshold where >50% of colonies are partially bleached, bleached, or dead
thresh2 <- as.tibble(res) %>%
  filter(Bleaching3 %in% c("Partially Bleached", "Bleached", "Dead")) %>%
  group_by(Species, dhw) %>%
  summarize(PBup = sum(prob)) %>%
  group_by(Species) %>%
  summarize(thresh = min(dhw[PBup > 0.5])) %>%
  mutate(Species = fct_reorder(Species, thresh))

# Plot bleaching levels with increasing DHW for each species
as.tibble(res) %>%
  mutate(Species = factor(Species, levels = levels(thresh$Species))) %>%
  ggplot(aes(x = dhw, y = prob, color = Bleaching3)) +
  geom_line() + 
  facet_wrap(~Species) +
  geom_vline(data = thresh, aes(xintercept = thresh), lty = 2, lwd = 0.25)

# Plot heatmap of proportion of colonies partially bleached or worse for each species
test <- as.tibble(res) %>%
  group_by(Species, dhw) %>%
  summarize(PBup = sum(prob[Bleaching3 %in% c("Partially Bleached", "Bleached", "Dead")])) %>%
  mutate(Species = factor(Species, levels = levels(thresh2$Species)))

ggplot(test, aes(x = dhw, y = Species, fill = PBup)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", 
                       limits = c(0, 1), midpoint = 0.5) +
  labs(guide = "hi")
```

```{r, eval = F}
ggplot(df23ss, aes(x = dhw, y = Bleaching2, color = Species)) +
  geom_point(alpha = 0.1) +
  facet_wrap(~Species)

# Bleaching as a function of DHW bin for each Species
mod <- lmerTest::lmer(Bleaching2 ~ Species * dhw.bin + (1|Site), data = df23ss)
anova(mod)

emm <- emmeans(mod, specs = c("Species", "dhw.bin"), at = list(dhw.bin = levels(df23ss$dhw.bin)))

as.tibble(emm) %>%
  ggplot(aes(x = dhw.bin, y = emmean, color = Species, group = Species)) +
  geom_point() +
  geom_line() +
  #facet_wrap(~Species) +
  ylim(0, 4)



# Need to try some binomial modeling with BL as response (1=BL, 0=notBL) to model proportion of colonies bleached at various locations and dhw levels....

mod <- glm((Bleaching2 >= 3) ~ Species * dhw, data = df23ss, family = "binomial")
emm <- emmeans(mod, specs = c("Species", "dhw"), at = list(dhw = seq(0,24,1)), mode = "prob", type = "response")
as.tibble(emm) %>%
  filter(Species %in% sppcounts$Species[which(sppcounts$n > 75)]) %>%
  ggplot(aes(x = dhw, y = response, color = Species, group = Species)) +
  geom_line()# +
  #facet_wrap(~Species)
```




```{r, eval = F}
# - [ ] Variability in bleaching among individuals within a species 
### which spp have the most variability among individuals?

var <- df23ss %>%
  group_by(Site, Latitude, Longitude, Species, Subregion, Zone) %>%
  summarize(n = n(),
            bleachvar = var(Bleaching2),
            max = max(Bleaching2)) %>%
  filter(n >= 10, max == 3, bleachvar > 0)

ggplot(var, aes(x = Species, y = bleachvar)) +
  geom_violin(scale = "width", draw_quantiles = 0.5) +
  geom_jitter(aes(color = Subregion), width = 0.2)

## where do tol. and sens. individuals co-occur?

var %>% filter(Species == "MCAV") %>%
  ggplot(aes(x = Longitude, y = Latitude)) +
  geom_point(aes(color = bleachvar))


#### Barplots of bleaching categories for each species
filter(df23ss, Species == "SSID") %>%
  ggplot(aes(x = Week, fill = factor(Bleaching2))) +
  geom_bar(position = "fill") +
  facet_grid(Subregion~"")
```

```{r, eval = F}
#  - [ ] Where are heat-tolerant individuals? i.e., most non-bleached individuals rel. to DHW

# Need to do this on the colony-level...
######## THIS IS REALLY GOOD VVVVVVVVVV
df23ss2 <- df23ss %>% 
  #filter(Subregion %in% c("Lower Keys", "Upper Keys", "Biscayne")) %>%
  #filter(Species %in% c("MCAV", "AAGA", "PPOR")) %>%
  mutate(Site = droplevels(Site)) %>%
  mutate(BL = Bleaching2 > 2)
mod <- glmer(BL ~ dhw * Depth + (dhw*Depth|Species) + (1|Week), ### what about (1|Site) to control for dhw and depth?
             family = "binomial", data = df23ss2,
             nAGQ = 0, control = glmerControl(optimizer = "nloptwrap"))

anova(mod)

test <- tibble(df23ss2, .resid = residuals(mod, type = "response"))
test2 <- test %>% group_by(Site, Longitude, Latitude) %>%
  summarize(meanResid = mean(.resid)) %>%
  arrange(meanResid)
# negative values indicate less bleaching than predicted based on dhw, depth, and species...

# Plot sites that bleached more/less than expected
myPlot <- ggplot(test2, aes(x = Longitude, y = Latitude, color = sign(meanResid) * meanResid^2,
                            size = meanResid^2)) +
  geom_point(alpha = 0.4) +
  scale_color_gradient2()
myPlot

myPlot + xlim(-82, -81) + ylim(24.2, 24.8)
myPlot + xlim(-81, -80) + ylim(24.5, 25.5)
myPlot + xlim(-80.3, -80) + ylim(25.5, 27) +
  geom_hline(yintercept = c(25.7588, 26.0923, 26.257518, 26.54476, 26.77238))


myPlot +
  geom_hline(yintercept = c(25.7588, 26.0923, 26.54476, 26.77238))



#### Plot on map?
# Download satellite map for Florida
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
world <- ne_countries(scale = "large", returnclass = "sf")
# Plot map
set.seed(10)
fig1a <- #ggmap(map_fl, extent = "panel") +
  ggplot(data = world) +
  geom_sf(lwd = 0, fill = "gray70") +
  coord_sf(xlim = c(-83.2, -79.5), ylim = c(23.7, 26.9), expand = FALSE) +
  scale_fill_manual(values = alpha(c("#F8766D", "#B79F00", "#00BA38", 
                                     "#00BFC4", "#619CFF", "#F564E3"), 0.7)) +
  # scale_y_continuous(breaks = c(24, 25, 26), labels = c(24, 25, 26)) +
  # scale_x_continuous(breaks = c(-82, -81, -80), labels = c(-82, -81, -80)) +
  theme(legend.position = "none") +
  theme(text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA)) +
  labs(y = "Latitude", x = "Longitude")
fig1a

hihihi <- fig1a +
  geom_point(data = test2, aes(x = Longitude, y = Latitude, fill = sign(meanResid) * meanResid^2,
                            size = meanResid^2), alpha = 0.5, stroke = 0.1, pch = 21) +
  scale_fill_gradient2(low = "red", mid = NA, high = "blue")
hihihi 
hihihi + coord_sf(xlim = c(-82, -80.8), ylim = c(24.4, 24.8))
hihihi + coord_sf(xlim = c(-81, -80), ylim = c(24.6, 25.5))
hihihi + coord_sf(xlim = c(-80.2, -80), ylim = c(25.5, 27)) +
  geom_hline(yintercept = c(25.7588, 26.0923, 26.257518, 26.54476, 26.77238)) +theme(aspect.ratio = 2)

# Is molasses an outlier as a site that did much better than expected?
#Y3042
y3042 <- df23 %>%
  filter(Site == "Y3042")
```


```{r, eval = F}
# - [ ] Are juveniles doing better (less bleaching) than larger adult colonies for any species?

# Model bleaching severity by species and size class
df23ss3 <- df23ss2 %>%
  mutate(sizeclass = case_when(Width <= 7 & (Old + Recent) <= 10 ~ "juv",
                               TRUE ~ "adult")) %>%
  filter(dhw > 10)
mod <- glmer(BL ~ sizeclass * Species + (1|Site) + (1|Week), 
             family = "binomial", data = df23ss3, 
             nAGQ = 0, control = glmerControl(optimizer = "nloptwrap"))

anova(mod)

emm <- emmeans(mod, specs = c("Species", "sizeclass"), type = "response")
as.tibble(emm) %>%
  ggplot(aes(x = sizeclass, y = prob)) +
  facet_wrap(~Species, scales = "free") +
  geom_point() +
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE))

stats <- rbind(contrast(emm, "pairwise", by = "Species")) %>%
  as.tibble() %>%
  arrange(p.value) %>%
  print(n = nrow(.))

sigspp <- stats %>%
  filter(p.value < 0.05)

as.tibble(emm) %>%
  filter(Species %in% sigspp$Species) %>%
  ggplot(aes(x = sizeclass, y = prob)) +
  facet_wrap(~Species, scales ="free") +
  geom_point() +
  geom_errorbar(aes(ymin = prob - SE, ymax = prob + SE))


# Size of BL vs UNBL MCAV
mcav <- df23ss2 %>% filter(Species == "PSTR")
mod <- glmer(BL ~ log(Width) * dhw + (1|Site), family = "binomial", data = mcav)
res <- emmeans(mod, specs = c("Width", "dhw"), at = list(Width = seq(min(mcav$Width),max(mcav$Width),2), dhw = 15), type = "response")
res
ggplot(as.tibble(res), aes(x = Width, y = prob)) +
  geom_line(aes(color = dhw, group = dhw)) +
  geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), alpha = 0.1)

ggplot(mcav, aes(x = BL, y = log(Width))) +
  geom_violin() +
  geom_jitter(width = 0.1)


ggplot(mcav, aes(x = cut(log(Width), 5), fill = BL)) +
  geom_bar(position = "fill")

range(mcav$Width)


### all species?
df23ss3 <- filter(df23ss2, Species %in% sppcounts$Species[1:10])
mod <- glmer(BL ~ Species * Width + dhw + (1|Site), family = "binomial", data = df23ss3,
             nAGQ = 0, control = glmerControl(optimizer = "nloptwrap"))
anova(mod)
res <- emmeans(mod, specs = c("Width", "Species", "dhw"), 
               at = list(Width = seq(4,500,2), dhw = 15), type = "response")
sizeranges <- df23ss3 %>% group_by(Species) %>% summarize(min = min(Width), max = max(Width))
sizeranges
res
ggplot(as.tibble(res), aes(x = Width, y = prob)) +
  geom_line(aes(color = Species, group = Species)) +
  geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), alpha = 0.1)

df23ss3 %>% filter(Width < 4)
```
    

    
