---
title: "Florida's 2015 Coral Bleaching"
subtitle: "Analysis of bleaching prevalence and patterns based on data from Florida FWC's Disturbance Response Monitoring Program"
author: "Ross Cunning"
output: html_document
date: "2024-04-30"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = F)
```

```{r}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(lme4)
library(emmeans)
library(ggridges)
library(gamm4)
library(MASS)
library(tidyverse)
```

# Import data

### DRM data
```{r import_drm}
# Import DRM data
df <- read_csv("data/drm/export.csv") %>%
  mutate(across(where(is.character), as_factor),
         Date = as_date(as.character(Date), format = "%m/%d/%Y"))

# Get day of the year number, week, and month for some model fitting
df <- df %>%
  mutate(Day = yday(Date),
         Week = week(Date),
         Week2 = factor(cut(Week, breaks = seq(0,52,2))),
         Week = factor(Week),
         Month = factor(month(Date)))

# Subset just 2015 surveys
df15 <- filter(df, year(Date) == "2015")

# Change Deerfield to either Broward or South Palm Beach based on Lat = 26.32825
df15[df15$Subregion == "Deerfield" & df15$Latitude > 26.32825, "Subregion"] <- "South Palm Beach"
df15[df15$Subregion == "Deerfield" & df15$Latitude < 26.32825, "Subregion"] <- "Broward-Miami"

# Order Subregions from south to north
df15 <- df15 %>%
  mutate(Subregion = fct_relevel(Subregion, c("Tortugas--Dry Tortugas NP", "Marquesas", "Lower Keys", 
                                              "Middle Keys", "Mid-Upper Keys Transition", "Upper Keys",
                                              "Biscayne", "Broward-Miami", "South Palm Beach", 
                                              "North Palm Beach", "Martin")))

# Order Species alphabetically
df15 <- df15 %>%
  mutate(Species = factor(Species, levels = sort(levels(df$Species))))

# Are there any dead corals?
# dead <- df15 %>% filter(Old + Recent >= 100)
# There are recently dead corals -- but this could have been SCTLD, in Biscayne up to Palm Beach....
# Assign dead corals NOT in those regions TRS (dead from bleaching)
df15[(df15$Old + df15$Recent) >= 100 & !df15$Subregion %in% c("Biscayne", "Broward-Miami", "South Palm Beach"), "Other Conditions"] <- "TRS"
# Remove other dead corals (disease death?)
df15 <- df15 %>%
  filter(((Old + Recent < 100) | grepl("TRS", `Other Conditions`)))

# Create ordinal variables and factors for bleaching severity
df15 <- df15 %>%
  mutate(Bleaching2 = case_when((is.na(Bleaching) & !grepl("TRS", `Other Conditions`)) ~ 0,
                                Bleaching == "P" ~ 1,
                                Bleaching == "PB" ~ 2,
                                Bleaching == "BL" ~ 3,
                                ((Old + Recent) >= 100 & grepl("TRS", `Other Conditions`)) ~ 4),
         Bleaching3 = factor(case_match(Bleaching2, 
                                 0 ~ "Healthy",
                                 1 ~ "Pale",
                                 2 ~ "Partially Bleached",
                                 3 ~ "Bleached",
                                 4 ~ "Dead"),
                             levels = c("Healthy", "Pale", "Partially Bleached", "Bleached", "Dead")))
```

### DHW data

```{r import_dhw}
# Import 2015 DHW data
dhw <- read_csv("data/dhw/2015/2015_dhw_processed.csv") %>%
  mutate(across(where(is.character), as_factor)) %>%
  rename(Date = date) %>%
  dplyr::select(Site, Date, dhw)

# Get DHW values for each DRM survey site on the date surveyed -- join with DRM data
df15 <- left_join(df15, dhw, by = c("Site", "Date"))

# Get peak DHW values for each site (weeks 36-38) regardless of when surveyed)
peakdhw <- dhw %>%
  mutate(Week2 = factor(cut(week(Date), breaks = seq(0,52,2)))) %>%
  filter(Week2 == "(36,38]") %>%
  group_by(Site) %>%
  summarize(peakdhw = max(dhw))
df15 <- left_join(df15, peakdhw)

# ggplot(df15, aes(x = dhw, y = peakdhw, color = Subregion)) + geom_point()
```

```{r}
save(df15, file = "output/2015.RData")
```

# DRM dataset summary

### Number of corals surveyed
```{r drm_summary_corals}
# Total number of colonies of each species surveyed
sppcounts <- df15 %>%
  count(Species) %>%
  arrange(-n) 

knitr::kable(tibble(`Total number of corals surveyed:` = sum(sppcounts$n)), align = 'l')

# Print table by species (split into multiple tables for display purposes)
knitr::kable(list(sppcounts[1:10, 1:2],
             sppcounts[11:20, 1:2],
             sppcounts[21:30, 1:2],
             sppcounts[31:40, 1:2], 
             sppcounts[41:50, 1:2]),
             label = "tables", booktabs = TRUE)
```

### Number of sites surveyed
```{r drm_summary_surveys}
# Total number of surveys conducted
surveys <- df15 %>%
  distinct(Subregion, Date, Site, dhw)

knitr::kable(tibble(`Total number of sites surveyed:` = n_distinct(surveys$Site)), align = 'l')


# # Number of sites and reef zones surveyed per Subregion
df15 %>%
  distinct(Subregion, Site, Zone) %>%
  group_by(Subregion) %>%
  ggplot(aes(x = Subregion, fill = Zone)) +
  geom_bar(position = "stack") +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  labs(x = "", y = "Number of sites surveyed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r subset_drm}
# Create subsets of DRM data for downstream analyses
### Subset just Subregions in the keys down
keys <- c("Upper Keys", "Mid-Upper Keys Transition", "Middle Keys", 
          "Lower Keys", "Marquesas", "Tortugas--Dry Tortugas NP")
### Subset just abundant species
sppcounts <- df15 %>%
  count(Species) %>%
  arrange(-n)
abund.spp <- sppcounts %>% filter(n > 30) %>% pull(Species)
### Create subsets
df15.keys <- df15 %>% filter(Subregion %in% keys)
df15.abund <- df15 %>% filter(Species %in% abund.spp)
df15.keys.abund <- df15 %>% filter(Subregion %in% keys, Species %in% abund.spp)
df15.abund.nopfursint <- df15.abund %>% filter(!Species %in% c("PFUR", "SINT"))
```

### How surveys were spread over time, and over the heatwave
```{r survey_distribution}
# How were 2023 surveys distributed across time and space?
surveys_by_date <- ggplot(surveys, aes(x = Date, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  labs(x = "Date", y = "") +
  theme(legend.position = "none")

# How were surveys distributed across DHW accumulation?
surveys_by_dhw <- ggplot(surveys, aes(x = dhw, y = Subregion, fill = Subregion)) +
  geom_density_ridges(alpha = 0.6, stat = "binline", bins = 20) +
  theme(legend.position = "none") +
  theme(axis.text.y = element_blank()) +
  labs(x = "Degree Heating Weeks", y = "") +
  xlim(-1, 10)

cowplot::plot_grid(surveys_by_date, surveys_by_dhw, ncol = 2, rel_widths = c(0.62, 0.38))
```



# Bleaching event summary

### DHWs by subregion
```{r dhw_summary}
# Plot DHWs for each individual site, colored by Subregion
alldhwplot <- dhw %>%
  left_join(distinct(df15, Site, Subregion)) %>%
  ggplot(aes(x = Date, y = dhw, color = Subregion, group = Site)) +
  geom_line(alpha = 0.3) +
  scale_y_continuous(breaks = seq(0, 23, 1)) +
  scale_x_date(breaks = "months", date_labels = "%b")

# Calculate mean DHW for all survey sites in each Subregion
meanDHW <- dhw %>%
  left_join(distinct(df15, Site, Subregion)) %>%
  group_by(Subregion, Date) %>%
  summarize(meanDHW = mean(dhw))

# Add mean DHW for each Subregion's sites to plot
alldhwplot +
  geom_line(data = meanDHW, aes(y = meanDHW, group = Subregion), lwd = 1)

# # Get maxdhw experienced in each Subregion
# maxmeanDHW <- meanDHW %>%
#   group_by(Subregion) %>%
#   summarize(maxmeanDHW = max(meanDHW))
```

DHWs in DRTO reached ~6-7.
DHWs in the Lower Keys reach ~7-9
DHWs in the Middle Keys reached ~6-7
DHWs in the Upper Keys reached ~4-6.
DHWs in Biscayne reached 2-3.
DHWs in Miami and Broward were <1-1.5

### Bleaching prevalence by subregion over time, and overall
```{r bleaching_summary_subregion_time}
# Percent of surveyed colonies with at least partial bleaching by Subregion and 2-Week periods
df15 %>%
  group_by(Week2, Subregion) %>%
  summarize(pctbl = sum(Bleaching2 > 1) / n()) %>%
  ggplot(aes(x = Week2, y = pctbl, group = Subregion, color = Subregion)) +
  geom_point() + 
  geom_line() +
  labs(y = "Percent of surveyed colonies with at least partial bleaching")

# Percent bleaching at all sites as function of DHW
df15 %>%
  group_by(Site, Subregion) %>%
  summarize(meandhw = mean(dhw),
              pctbl = sum(Bleaching2 > 1) / n()) %>%
  ggplot(aes(x = meandhw, y = pctbl)) +
  geom_point(aes(color = Subregion)) +
  geom_smooth(method = "gam") +
  labs(x = "DHW at time of survey", y = "Percent of surveyed colonies with at least partial bleaching")
```



```{r bleaching_summary_overall_subregion}
# Count number of bleached and unbleached colonies of each species at each site
summ <- df15.abund %>%
  group_by(Site, Species, Subregion, Week, Week2) %>%
  summarize(bl = sum(Bleaching2 > 1, na.rm = T),
            nb = sum(Bleaching2 <= 1, na.rm = T),
            dhw = mean(dhw))

# Plot raw proportion of bleached colonies surveyed in each subregion
summ %>%
  group_by(Subregion) %>%
  summarize(pctbl = sum(bl) / (sum(bl) + sum(nb)),
            dhw = mean(dhw)) %>%
  mutate(group = "allcorals") %>%
  ggplot(aes(y = Subregion)) +
  geom_point(aes(x = pctbl)) +
  geom_path(aes(x = pctbl, group = group)) +
  geom_point(aes(x = dhw / 25), color = "red") +
  geom_path(aes(x = dhw / 25, group = group), color = "red") +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, 0.1),
                     name = "% of all corals PB or worse when surveyed",
                     sec.axis = sec_axis(~.*25, name = "Mean DHWs when surveyed")) +
  theme(axis.text.x.top = element_text(color = "red"),
        axis.title.x.top = element_text(color = "red")) +
  labs(y = "")


# Model proportion of bleached colonies in each subregion, controlling for species and week of survey
## Use 2-Week periods in model, and predict based on weeks 36-38 (Week2 = "(36,38]" => September 7-20 = peak of heat stress, before too much mortality
mod <- glm(cbind(bl, nb) ~ Subregion + Species + Week2 + Species , family = "binomial", data = summ)
res <- emmeans(mod, specs = c("Subregion"), at = list(Week2 = factor("(36,38]")), type = "response")
# Join predicted bleaching prevalence for Sep7-20 with average DHWs during same dates
mymaxdhw <- dhw %>%
  left_join(distinct(df15, Site, Subregion)) %>%
  filter(Date >= "2015-09-07", Date <= "2015-09-20") %>%
  group_by(Subregion, Date) %>%
  summarize(meanDHW = mean(dhw)) %>%
  group_by(Subregion) %>%
  summarize(maxDHW = max(meanDHW)) %>%
  drop_na()

regional15 <- as.tibble(res) %>% full_join(mymaxdhw) %>%
  mutate(group = "allcorals")

ggplot(regional15, aes(y = Subregion)) +
  geom_point(aes(x = prob)) +
  geom_errorbar(aes(xmin = asymp.LCL, xmax = asymp.UCL), width = 0) +
  geom_path(aes(x = prob, group = group)) +
  geom_point(aes(x = maxDHW / 10), color = "red") +
  geom_path(aes(x = maxDHW / 10, group = group), color = "red") +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0), breaks = seq(0, 1, 0.1),
                     name = "Predicted % of 'avg coral' PB or worse [Sep7-20]",
                     sec.axis = sec_axis(~.*10, name = "Max DHW [Sep7-20]")) +
  theme(axis.text.x.top = element_text(color = "red"),
        axis.title.x.top = element_text(color = "red")) +
  labs(y = "")
  

save(regional15, file = "output/regional15.RData")
```



### Levels of bleaching observed with increasing DHWs
```{r bleaching_vs_dhw}
# Ordinal regression: Probability of each bleaching level with increasing DHW
m <- polr(Bleaching3 ~ dhw * Species + Depth + Week2, data = df15.abund, Hess = TRUE, model = TRUE)

# Model includes Depth and Species, and predicts probability of each bleaching level 
# for the average coral species at the average depth (we choose 23 ft as median depth of all corals obs.)
res <- emmeans(m, specs = c("dhw", "Bleaching3"), 
               at = list(dhw = seq(0, 10, 0.5),
                         Week2 = factor("(36,38]"),
                         Depth = 23), 
               mode = "prob")
as.tibble(res) %>%
  ggplot(aes(x = dhw, y = prob, color = Bleaching3)) +
  geom_line() +
  labs(x = "Degree Heating Weeks", y = "Predicted probability")
```

```{r}
# Just probability of PB or greater
m <- glm(Bleaching2 > 1 ~ Species * dhw + Depth + Week2, family = "binomial", data = df15.abund)

# Get fitted values across dhw [normalize to Aug13-26 window of bleaching rates]
res <- emmeans(m, specs = c("dhw"), rg.limit = 20000, type = "response",
               at = list(Week2 = factor("(36,38]"), Depth = 23, dhw = seq(0, 10, 0.1)))

as.tibble(res) %>%
  ggplot(aes(x = dhw, y = response)) +
  geom_line() +
  geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), lwd = 0, alpha = 0.3)

bleachprob15 <- as.tibble(res)
saveRDS(bleachprob15, file = "output/bleachprob15.rds")
```

# Coral species differences in bleaching

### Bleaching prevalence by species in each subregion
```{r bleaching_by_species_and_region}
# Model probability of being at least Partially bleached by Species and Subregion (controlling for Week)
### Subset: only include species observed at least 3 times in a Subregion...
df15.abund.ss <- df15.abund %>%
  count(Species, Subregion) %>%
  filter(n >=3) %>%
  left_join(df15.abund)
# Fit model
### Debating whether week should be included here or not? has a big effect on overall bleaching levels
mod <- glm((Bleaching2 > 1) ~ Subregion * Species + Week2, 
             family = "binomial", data = df15.abund)
res <- as.tibble(emmeans(mod, specs = c("Species", "Subregion"), 
                         at = list(Week2 = factor("(36,38]")), 
                         type = "response")) %>% drop_na()
# Plot
ggplot(res, aes(y = Subregion, x = response, color = Species, group = Species)) +
  geom_point() + 
  #geom_line() +
  geom_path() +
  facet_wrap(~Species, ncol = 7) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(y = "", x = "Predicted % of colonies PB or worse")

# Actual proportions rather than statistically modeled as a doublecheck
df15.abund %>%
  group_by(Subregion, Species) %>%
  summarize(pctbl = sum(Bleaching2 > 1) / n()) %>%
  ggplot(aes(y = Subregion, x = pctbl, color = Species, group = Species)) +
  geom_point() +
  #geom_line() +
  geom_path() +
  facet_wrap(~Species, ncol = 7) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(y = "", x = "Actual % of colonies PB or worse")
```



### Species differences in bleaching with increasing DHWs
```{r bleaching_by_species}
# Probability of each bleaching level by species as a function of DHW (ordinal regression)
#https://tdunn.ca/posts/2020-03-15-ordinal-regression-in-r-part-1/

# Fit ordinal regression model for each species as a function of DHW and 2-week survey window
m <- MASS::polr(Bleaching3 ~ Species * dhw + Week2, data = df15.abund, Hess = TRUE, model = TRUE)

# Get fitted values across dhw [normalize to Aug13-26 window of bleaching rates]
res <- emmeans(m, specs = c("dhw", "Bleaching3"), by = "Species", mode = "prob", 
               at = list(dhw = seq(0, 10, 1), Week2 = factor("(36,38]")))

# Get thresholds where >50% of colonies are PB or worse, and B or worse
thresh <- as.tibble(res) %>%
  group_by(Species, dhw) %>%
  summarize(PBup = sum(prob[Bleaching3 %in% c("Partially Bleached", "Bleached", "Dead")]),
             Bup = sum(prob[Bleaching3 %in% c("Bleached", "Dead")]))

# Rank corals based on PB or B threshold from above
ranks <- thresh %>%
  group_by(Species) %>%
  summarize(thresh0.5 = min(dhw[PBup > 0.5]),
            thresh0.25 = min(dhw[PBup > 0.25]),
            thresh0.75 = min(dhw[PBup > 0.75])) %>%
  mutate(Species = fct_reorder(Species, thresh0.5))

# Plot all bleaching levels as function of DHW for each species
as.tibble(res) %>%
  mutate(Species = factor(Species, levels = levels(ranks$Species))) %>%
  ggplot(aes(x = dhw, y = prob, color = Bleaching3)) +
  geom_line() + 
  facet_wrap(~Species) +
  geom_vline(data = ranks, aes(xintercept = thresh0.5), lty = 2, lwd = 0.25)

# Plot heatmap of proportion of colonies partially bleached or worse for each species
thresh %>%
  mutate(Species = factor(Species, levels = levels(ranks$Species))) %>%
  ggplot(aes(x = dhw, y = Species)) +
  geom_tile(aes(fill = PBup)) +
  scale_fill_gradient2(low = "#91cf60", mid = "#ffffbf", high = "#fc8d59", 
                       limits = c(0, 1), midpoint = 0.5) +
  geom_point(data = ranks, aes(x = thresh0.5), pch = 5) +
  geom_segment(data = ranks, aes(yend = Species, x = thresh0.5, xend = thresh0.25)) +
  geom_segment(data = ranks, aes(yend = Species, x = thresh0.5, xend = thresh0.75)) +
  labs(x = "Degree Heating Weeks", y = "", fill = "Proportion\nof colonies\nPB or worse")
```

```{r}
# Species-specific bleaching susceptibility w/increasing DHW
## Plot raw data/bleaching categoties by binned.dhw
ggplot(df15.abund, aes(x = cut(dhw, 10), fill = Bleaching3)) +
  geom_bar(position = "fill") +
  facet_wrap(~Species, scales = "free_y")

## Include only species with ≥3 individuals in ≥70% of dhw bins
incl_spp <- df15.abund %>%
  count(Species, cut(dhw, 10)) %>%
  group_by(Species) %>%
  filter((sum(n >= 3) >= 7)) %>%
  distinct(Species)

df15.abund.ss <- filter(df15.abund, Species %in% incl_spp$Species)

# Fit regression for PB or worse
m <- glm(Bleaching2 > 1 ~ Species * dhw + Week2, family = "binomial", data = df15.abund.ss)

# Get fitted values across dhw [normalize to Aug13-26 window of bleaching rates]
res <- emmeans(m, specs = c("Species", "dhw"), rg.limit = 20000, type = "response",
               at = list(Week2 = factor("(36,38]"), dhw = seq(0, 10, 0.1)))
emt <- emtrends(m, specs = "Species", var = "dhw")
sig <- summary(emt, infer = TRUE) %>%
  filter(p.value < 0.05)


as.tibble(res) %>%
  filter(Species %in% sig$Species) %>%
  ggplot(aes(x = dhw, y = response)) +
  geom_line() +
  geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), lwd = 0, alpha = 0.3) +
  facet_wrap(~Species)

sppbleachprob15 <- as.tibble(res)
saveRDS(sppbleachprob15, file = "output/sppbleachprob15.rds")
```

```{r BINS}
# Species-specific bleaching susceptibility w/increasing DHW
## Plot raw data/bleaching categoties by binned.dhw
ggplot(df15.abund, aes(x = cut(dhw, breaks = seq(0,9,3)), fill = Bleaching3)) +
  geom_bar(position = "fill") +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = "inward", position = "fill", size = 2) +
  facet_wrap(~Species, scales = "free_y")

## Include only species with ≥3 individuals in ≥70% of dhw bins
incl_spp <- df15.abund %>%
  count(Species, cut(dhw, breaks = seq(0,9,3))) %>%
  group_by(Species) %>%
  filter((sum(n >= 3) >= 2)) %>%
  distinct(Species)

df15.abund.ss <- filter(df15.abund, Species %in% incl_spp$Species) %>%
  mutate(dhw.bin = cut(dhw, breaks = seq(0,9,3)))

# Fit regression for PB or worse
m <- glm(Bleaching2 > 1 ~ Species * dhw.bin + Week2, family = "binomial", data = df15.abund.ss)

# Get fitted values across dhw [normalize to Aug13-26 window of bleaching rates]
res <- emmeans(m, specs = c("Species", "dhw.bin"), rg.limit = 20000, type = "response",
               at = list(Week2 = factor("(36,38]")))

as.tibble(res) %>%
  filter(Species %in% sig$Species) %>%
  ggplot(aes(x = dhw.bin, y = response)) +
  geom_point() +
  facet_wrap(~Species)

sppbleachprob15 <- as.tibble(res)
saveRDS(sppbleachprob15, file = "output/sppbleachprob15.rds")
```


# Coral size class differences in bleaching severity

### Are juveniles doing better (less bleaching) than larger adult colonies?
```{r size_effects}
# Model bleaching severity by Width, species, and dhw. 
# There are some corals with Width < 4 -- these were included because Height should have been at least 4. In these cases change Width to 4.
df15.abund <- df15.abund %>%
  mutate(Width2 = case_when(Width >= 4 ~ Width,
                            Width < 4 ~ 4))

# Fit model
mod <- glm(Bleaching2 > 1 ~ Species * Width2 * dhw + Week2, family = "binomial", data = df15.abund)
#plot(mod, which = 1)

# Test if significant effect of width for each species
res <- emtrends(mod, specs = c("Species", "dhw"), var = "Width2",
                at = list(dhw = 10))
# Get significant species
sig <- as.tibble(summary(res, infer = TRUE)) %>%
  filter(p.value < 0.05)

# Get fitted values for bleaching probability as a function of size for significant species
pred <- as.tibble(emmeans(mod, specs = c("Width2", "dhw"), by = "Species", 
                          at = list(Width2 = seq(4,500,5), dhw = 10), 
                          type = "response", rg.limit = 20000)) %>%
  filter(Species %in% sig$Species) %>%
  left_join(select(sig, dhw, Species, asymp.LCL), by = c("dhw", "Species"))
# Get actual observed size ranges for these species
actual <- filter(df15.abund) %>%
  drop_na(Species) %>%
  group_by(Species) %>%
  summarize(min = min(Width2, na.rm = T), max = max(Width2, na.rm = T)) %>%
  mutate(ad = map(max, ~expand_grid(Width2 = seq(4, ., 5)))) %>%
  unnest(ad)
pred2 <- pred %>%
  semi_join(actual, by = c("Species", "Width2"))
  
# Plot fitted probabilities within the range of observed Widths for each significant species
ggplot(pred2, aes(x = Width2, y = response, color = factor(dhw), group = dhw, linetype = is.na(asymp.LCL.y))) +
  facet_wrap(~Species, scales = "free_x") +
  geom_line() +
  geom_ribbon(aes(ymin = asymp.LCL.x, ymax = asymp.UCL), alpha = 0.2, lwd = 0) +
  #geom_errorbar(aes(ymin = response - SE, ymax = response + SE)) +
  ylim(0, 1) +
  labs(x = "Colony width", y = "Proportion of colonies PB or worse") +
  theme(legend.position = "none")


# Plot actual proportions binned by size class
# filter(df14.abund, dhw > 4) %>%
#   filter(Species %in% sig$Species) %>%
#   group_by(Species) %>%
#   mutate(Width.bin = cut(log(Width), breaks = 5)) %>%
#   ggplot(aes(x = Width.bin, fill = Bleaching2 > 1)) +
#   geom_bar(position = "fill") +
#   facet_wrap(~Species, scales = "free")
```




# Mapping bleaching anomalies: exploring deviations from expected severity

### Which sites bleached more or less than predicted based on DHW, depth, and species composition?
```{r bleach_resid_sites}
# Model bleaching outlier locations with group-level data (groups = each species at each site)
# Following: https://library.virginia.edu/data/articles/understanding-deviance-residuals
# Get subset of data
dfdf <- df15 %>%
  group_by(Species, Site, dhw, Depth, Week2, Longitude, Latitude, Subregion) %>%
  summarize(BL = sum(Bleaching2 > 2),   # BL is fully bleached or dead
            NB = sum(Bleaching2 <= 2)) %>% # NB is healthy, pale, or partially bleached
  ungroup() %>%
  filter(BL + NB >=3)  # only keep groups (species at sites) with at least 3 individuals observed

# Fit model
mod <- glm(cbind(BL, NB) ~ Species * dhw + Depth + Week2, family = "binomial", data = dfdf)

# Get residuals (raw residuals = difference between observed and predicted bleaching probability)
res <- tibble(dfdf, .resid = residuals(mod, type = "response"))

# Plot residuals for each species at each site
## (Where did each coral species do better or worse than expected?)
# ggplot(res, aes(x = Longitude, y = Latitude, color = .resid)) +
#   geom_point() +
#   facet_wrap(~Species) +
#   scale_color_gradient2(low = "red", mid = NA, high = "blue")

# Get mean site residuals across species, 
# and keep only sites where more than one species occurred (with at least 3 ind. each)
site.resid <- res %>%
  group_by(Site, Longitude, Latitude) %>%
  filter(n() > 1) %>%
  summarize(meanResid = mean(.resid))

# Plot on map
# Download satellite map for Florida
world <- ne_countries(scale = "large", returnclass = "sf")
# Plot basemap
basemap <- ggplot(data = world) +
  geom_sf(lwd = 0, fill = "gray70") +
  coord_sf(xlim = c(-83.2, -79.8), ylim = c(24.3, 27.3), expand = FALSE) +
  theme(legend.position = "none") +
  theme(text = element_text(size = 10),
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA))

# Get subsets of map range for multipanel plot
flmap <- basemap +
  geom_point(data = site.resid, aes(x = Longitude, y = Latitude, fill = meanResid,
                            size = meanResid^2), alpha = 0.5, stroke = 0.1, pch = 21) +
  scale_fill_gradient2(low = "red", mid = NA, high = "blue", midpoint = 0,
                       limits = c(-1, 1))# +
  # geom_rect(aes(xmin = -83, xmax = -82, ymin = 24.4, ymax = 24.75), fill = NA, color = "black", lwd = 0.1) +
  # geom_rect(aes(xmin = -82, xmax = -81, ymin = 24.4, ymax = 24.75), fill = NA, color = "black", lwd = 0.1) +
  # geom_rect(aes(xmin = -81, xmax = -80, ymin = 24.65, ymax = 25.65), fill = NA, color = "black", lwd = 0.1) +
  # geom_rect(aes(xmin = -80.4, xmax = -79.8, ymin = 25.65, ymax = 26.8), fill = NA, color = "black", lwd = 0.1)
dtmap <- basemap + coord_sf(xlim = c(-83, -82), ylim = c(24.4, 24.75), expand = FALSE)
lkmap <- basemap + coord_sf(xlim = c(-82, -81), ylim = c(24.4, 24.75), expand = FALSE)
ukmap <- basemap + coord_sf(xlim = c(-81, -80), ylim = c(24.65, 25.65), expand = FALSE)
semap <- basemap + coord_sf(xlim = c(-80.4, -79.8), ylim = c(25.65, 26.8), expand = FALSE)

# Create and save multipanel plot
maps_multipanel_grouplevel <- gridExtra::arrangeGrob(
  flmap, lkmap, dtmap, ukmap, semap, 
  layout_matrix = matrix(c(1,1,1,1,2,3,2,3,4,4,4,4,5,5), nrow=2))
ggsave(filename = "output/2015_maps_multipanel_grouplevel.png", 
       plot = maps_multipanel_grouplevel, width = 16, height = 4, unit = "in")

# Print whole map
flmap + theme(legend.position = "right") +
  labs(fill = "Difference from predicted\nbleaching prevalence")

```
```
![](output/2015_maps_multipanel_grouplevel.png)




```{r, eval = F}
# Try random forests to find outlier sites or individuals?
library(randomForest)
data <- df15.abund %>%
  #filter(Species %in% c("CNAT", "DLAB", "MCAV", "OANN", "OFAV", "PAST", "PSTR", "SSID")) %>%
  mutate(Bleaching4 = factor(case_when(Bleaching3 %in% c("Healthy", "Pale") ~ "Healthy",
                                Bleaching3 %in% c("Partially Bleached", "Bleached", "Dead") ~ "Bleached"))) %>%
  droplevels()

# Run random forest classification with species, depth, and dhw as predictors
rf <- randomForest(Bleaching4~Species+Depth+dhw, data = data, ntree = 10, do.trace = TRUE, proximity=TRUE)
print(rf)
rf$confusion

str(rf)

# Get rf model predictions for Bleaching4
data <- data %>%
  mutate(pred = rf$predicted)

# How accurate were predictions for each species?
data %>%
  drop_na(pred) %>%
  group_by(Species) %>%
  count(acc = pred == Bleaching4) %>%
  ggplot(aes(x = Species, y = n, fill = acc)) +
  geom_col(position= "fill")

# Can you get confidence?
str(rf)
score(rf)

data %>%
  drop_na(pred) %>%
  ggplot(aes(x = Species, fill = Bleaching4:pred)) +
  geom_bar(position = "fill")
  
  

# Which corals were predicted to be bleached, but were actually healthy?
outhealthy <- data %>%
  filter(pred == "Bleached", Bleaching4 == "Healthy") 

ggplot(outhealthy, aes(x = Longitude, y = Latitude)) +
  geom_point(color = "red", alpha = 0.005, pch = 20)

outhealthy %>%
  filter(Species == "OFAV") %>%
  ggplot(aes(x = Longitude, y = Latitude)) +
  geom_point(aes(color = Species))
```


  

```{r, eval = F}
# - [ ] Variability in bleaching among individuals within a species 
### which spp have the most variability among individuals?
## where do tol. and sens. individuals co-occur?

var <- df15.abund %>%
  group_by(Site, Latitude, Longitude, Species, Subregion, Zone) %>%
  summarize(n = n(),
            bleachvar = var(Bleaching2),
            max = max(Bleaching2))

ggplot(var, aes(x = Species, y = bleachvar)) +
  geom_violin(scale = "width", draw_quantiles = 0.5) +
  geom_jitter(aes(color = Subregion), width = 0.2)



var %>% filter(Species == "MCAV") %>%
  ggplot(aes(x = Longitude, y = Latitude)) +
  geom_point(aes(color = bleachvar))
```
  
